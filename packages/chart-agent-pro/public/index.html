<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chart Agent Pro v2</title>
    <style>
        :root {
            --primary: #4F46E5;
            --primary-hover: #4338CA;
            --primary-light: #EEF2FF;
            --success: #10B981;
            --warning: #F59E0B;
            --error: #EF4444;
            --bg: #F9FAFB;
            --bg-card: #FFFFFF;
            --text: #111827;
            --text-muted: #6B7280;
            --border: #E5E7EB;
            --shadow: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-lg: 0 4px 12px rgba(0,0,0,0.15);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            height: 100vh;
            overflow: hidden;
        }

        /* ===== LAYOUT ===== */
        .app-container {
            display: flex;
            flex-direction: column;
            height: 100vh;
        }

        .header {
            background: var(--primary);
            color: white;
            padding: 8px 16px;
            display: flex;
            align-items: center;
            gap: 12px;
            flex-shrink: 0;
        }

        .header-logo { font-size: 1.25rem; }
        .header-title { font-weight: 600; font-size: 0.95rem; }
        .header-version { font-size: 0.7rem; opacity: 0.7; }

        .header-status {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.75rem;
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--success);
        }

        .status-indicator.disconnected { background: var(--error); }
        .status-indicator.loading { background: var(--warning); animation: pulse 1s infinite; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .header-btn {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            padding: 6px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
            transition: background 0.2s;
        }

        .header-btn:hover { background: rgba(255,255,255,0.3); }

        .main-content {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 380px;
            background: var(--bg-card);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        /* ===== SUGGESTIONS PANEL ===== */
        .suggestions-panel {
            border-bottom: 1px solid var(--border);
            background: linear-gradient(135deg, var(--primary-light) 0%, #F0F9FF 100%);
            display: none;
        }

        .suggestions-panel.visible { display: block; }

        .suggestions-header {
            font-size: 0.7rem;
            font-weight: 600;
            text-transform: uppercase;
            color: var(--primary);
            padding: 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            cursor: pointer;
            user-select: none;
        }

        .suggestions-header:hover {
            background: rgba(79, 70, 229, 0.05);
        }

        .suggestions-toggle {
            background: none;
            border: none;
            color: var(--primary);
            font-size: 0.7rem;
            cursor: pointer;
            transition: transform 0.2s;
            padding: 4px;
        }

        .suggestions-panel.collapsed .suggestions-toggle {
            transform: rotate(-90deg);
        }

        .suggestions-content {
            padding: 0 12px 12px 12px;
            overflow: hidden;
            transition: max-height 0.3s ease, opacity 0.2s ease;
            max-height: 500px;
            opacity: 1;
        }

        .suggestions-panel.collapsed .suggestions-content {
            max-height: 0;
            padding-bottom: 0;
            opacity: 0;
        }

        .suggestions-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .suggestion-card {
            flex: 1 1 calc(50% - 4px);
            min-width: 120px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: all 0.2s;
            text-align: center;
        }

        .suggestion-card:hover {
            border-color: var(--primary);
            box-shadow: var(--shadow);
            transform: translateY(-1px);
        }

        .suggestion-card.selected {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .suggestion-icon { font-size: 1.5rem; margin-bottom: 4px; }
        .suggestion-title { font-size: 0.75rem; font-weight: 500; color: var(--text); line-height: 1.3; }
        .suggestion-subtitle { font-size: 0.65rem; color: var(--text-muted); margin-top: 2px; }

        .suggestions-loading {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--primary);
            font-size: 0.8rem;
        }

        .mini-spinner {
            width: 16px;
            height: 16px;
            border: 2px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin { to { transform: rotate(360deg); } }

        /* ===== CHAT ===== */
        .chat-section {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .chat-header {
            padding: 12px;
            border-bottom: 1px solid var(--border);
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        /* Message Bubbles */
        .message {
            max-width: 95%;
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .message.user { align-self: flex-end; }
        .message.assistant { align-self: flex-start; }

        .message-bubble {
            padding: 10px 14px;
            border-radius: 12px;
            font-size: 0.85rem;
            line-height: 1.5;
        }

        .message.user .message-bubble {
            background: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .message.assistant .message-bubble {
            background: var(--bg);
            border-bottom-left-radius: 4px;
        }

        .message.system .message-bubble {
            background: var(--primary-light);
            color: var(--primary);
            font-size: 0.8rem;
            text-align: center;
            align-self: center;
        }

        /* Clarification Options */
        .clarification-options {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-top: 4px;
        }

        .clarification-option {
            padding: 10px 14px;
            background: white;
            border: 1px solid var(--border);
            border-radius: 8px;
            cursor: pointer;
            text-align: left;
            transition: all 0.2s;
        }

        .clarification-option:hover {
            border-color: var(--primary);
            background: var(--primary-light);
        }

        .clarification-option-label {
            font-weight: 500;
            font-size: 0.85rem;
            color: var(--text);
        }

        .clarification-option-desc {
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        /* Suggested Actions */
        .suggested-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 8px;
        }

        .action-btn {
            padding: 6px 12px;
            background: white;
            border: 1px solid var(--primary);
            border-radius: 16px;
            color: var(--primary);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .action-btn:hover {
            background: var(--primary);
            color: white;
        }

        /* Chart Preview in Chat */
        .message-chart-preview {
            background: var(--bg);
            border: 1px solid var(--border);
            border-radius: 8px;
            padding: 8px;
            margin-top: 4px;
        }

        .message-chart-preview img {
            max-width: 100%;
            border-radius: 4px;
        }

        .message-chart-preview-link {
            display: block;
            text-align: center;
            font-size: 0.75rem;
            color: var(--primary);
            margin-top: 6px;
            cursor: pointer;
        }

        /* Typing Indicator */
        .typing-indicator {
            display: flex;
            gap: 4px;
            padding: 12px 16px;
            background: var(--bg);
            border-radius: 12px;
            border-bottom-left-radius: 4px;
            align-self: flex-start;
        }

        .typing-indicator span {
            width: 8px;
            height: 8px;
            background: var(--text-muted);
            border-radius: 50%;
            animation: typing 1.4s infinite ease-in-out;
        }

        .typing-indicator span:nth-child(1) { animation-delay: 0s; }
        .typing-indicator span:nth-child(2) { animation-delay: 0.2s; }
        .typing-indicator span:nth-child(3) { animation-delay: 0.4s; }

        @keyframes typing {
            0%, 60%, 100% { transform: translateY(0); opacity: 0.4; }
            30% { transform: translateY(-4px); opacity: 1; }
        }

        .chat-input-area {
            padding: 12px;
            border-top: 1px solid var(--border);
            display: flex;
            gap: 8px;
        }

        .chat-input {
            flex: 1;
            padding: 10px 14px;
            border: 1px solid var(--border);
            border-radius: 20px;
            font-size: 0.85rem;
            outline: none;
            resize: none;
            min-height: 40px;
            max-height: 100px;
        }

        .chat-input:focus { border-color: var(--primary); }

        .chat-send-btn {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--primary);
            color: white;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1rem;
            transition: background 0.2s;
            flex-shrink: 0;
        }

        .chat-send-btn:hover { background: var(--primary-hover); }
        .chat-send-btn:disabled { background: var(--text-muted); cursor: not-allowed; }

        /* ===== CHART AREA ===== */
        .chart-area {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            background: white;
        }

        .chart-toolbar {
            padding: 8px 16px;
            border-bottom: 1px solid var(--border);
            display: none;
            align-items: center;
            gap: 8px;
            background: var(--bg);
        }

        .chart-toolbar.visible { display: flex; }

        .chart-title { font-weight: 600; font-size: 0.9rem; flex: 1; }

        .chart-action {
            padding: 4px 10px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: white;
            font-size: 0.75rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .chart-action:hover { background: var(--bg); }

        .chart-container {
            flex: 1;
            position: relative;
            overflow: hidden;
        }

        .chart-frame {
            width: 100%;
            height: 100%;
            border: none;
        }

        .chart-placeholder {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: var(--text-muted);
            text-align: center;
            padding: 40px;
        }

        .chart-placeholder-icon { font-size: 4rem; margin-bottom: 16px; opacity: 0.3; }
        .chart-placeholder-text { font-size: 1rem; margin-bottom: 8px; color: var(--text); }
        .chart-placeholder-hint { font-size: 0.85rem; max-width: 300px; }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.9);
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 12px;
            z-index: 100;
        }

        .loading-overlay.visible { display: flex; }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .loading-text { font-size: 0.85rem; color: var(--text-muted); }

        /* ===== SETTINGS MODAL ===== */
        .modal-overlay {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-overlay.visible { display: flex; }

        .modal {
            background: white;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            overflow: hidden;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            padding: 16px;
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .modal-title { font-weight: 600; }

        .modal-close {
            background: none;
            border: none;
            font-size: 1.25rem;
            cursor: pointer;
            color: var(--text-muted);
        }

        .modal-body { padding: 16px; }

        .modal-footer {
            padding: 16px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 8px;
        }

        .form-group { margin-bottom: 16px; }
        .form-label { display: block; font-size: 0.8rem; font-weight: 500; margin-bottom: 6px; }

        .form-input {
            width: 100%;
            padding: 10px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            font-size: 0.85rem;
        }

        .form-input:focus { outline: none; border-color: var(--primary); }

        .btn {
            padding: 8px 16px;
            border-radius: 6px;
            font-size: 0.85rem;
            cursor: pointer;
            border: 1px solid var(--border);
            background: white;
        }

        .btn:hover { background: var(--bg); }

        .btn-primary {
            background: var(--primary);
            color: white;
            border-color: var(--primary);
        }

        .btn-primary:hover { background: var(--primary-hover); }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header">
            <span class="header-logo">üìä</span>
            <span class="header-title">Chart Agent Pro</span>
            <span class="header-version">v2</span>
            <div class="header-status">
                <span class="status-indicator" id="status-indicator"></span>
                <span id="status-text">Connexion...</span>
            </div>
            <button class="header-btn" onclick="app.openSettings()">‚öôÔ∏è</button>
        </header>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Sidebar -->
            <aside class="sidebar">
                <!-- Suggestions Panel -->
                <div class="suggestions-panel" id="suggestions-panel">
                    <div class="suggestions-header" onclick="app.toggleSuggestions()">
                        <span>‚ú® Suggestions</span>
                        <button class="suggestions-toggle" id="suggestions-toggle">‚ñº</button>
                    </div>
                    <div class="suggestions-content" id="suggestions-content">
                        <div class="suggestions-grid" id="suggestions-grid"></div>
                    </div>
                </div>

                <!-- Chat -->
                <div class="chat-section">
                    <div class="chat-header">üí¨ Assistant IA</div>
                    <div class="chat-messages" id="chat-messages"></div>
                    <div class="chat-input-area">
                        <input type="text" class="chat-input" id="chat-input"
                               placeholder="Posez une question ou demandez un graphique..."
                               onkeydown="if(event.key==='Enter' && !event.shiftKey) { event.preventDefault(); app.sendMessage(); }">
                        <button class="chat-send-btn" id="chat-send-btn" onclick="app.sendMessage()">‚û§</button>
                    </div>
                </div>
            </aside>

            <!-- Chart Area -->
            <main class="chart-area">
                <div class="chart-toolbar" id="chart-toolbar">
                    <span class="chart-title" id="chart-title">Visualisation</span>
                    <button class="chart-action" onclick="app.expandChart()">üîç Agrandir</button>
                    <button class="chart-action" onclick="app.downloadChart()">üì• T√©l√©charger</button>
                </div>

                <div class="chart-container" id="chart-container">
                    <div class="chart-placeholder" id="chart-placeholder">
                        <div class="chart-placeholder-icon">üìà</div>
                        <div class="chart-placeholder-text">Aucune visualisation</div>
                        <div class="chart-placeholder-hint">
                            Posez une question √† l'assistant ou cliquez sur une suggestion.
                        </div>
                    </div>
                    <iframe class="chart-frame" id="chart-frame" style="display: none;"></iframe>
                    <div class="loading-overlay" id="chart-loading">
                        <div class="loading-spinner"></div>
                        <div class="loading-text" id="loading-text">Analyse en cours...</div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Settings Modal -->
    <div class="modal-overlay" id="settings-modal">
        <div class="modal">
            <div class="modal-header">
                <span class="modal-title">‚öôÔ∏è Configuration</span>
                <button class="modal-close" onclick="app.closeSettings()">√ó</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label class="form-label">URL du webhook n8n</label>
                    <input type="text" class="form-input" id="input-webhook-url"
                           placeholder="https://n8n.example.com/webhook/chart-agent">
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn" onclick="app.closeSettings()">Annuler</button>
                <button class="btn btn-primary" onclick="app.saveSettings()">Enregistrer</button>
            </div>
        </div>
    </div>

    <script src="https://docs.getgrist.com/grist-plugin-api.js"></script>
    <script>
    // ============================================================
    // CHART AGENT PRO v2 - CONVERSATIONAL MULTI-AGENT ARCHITECTURE
    // ============================================================

    // ===== CONVERSATION MANAGER =====
    class ConversationManager {
        constructor() {
            this.sessionId = this.generateUUID();
            this.history = [];
            this.context = {
                activeChart: null,
                pendingClarification: null,
                appliedFilters: [],
                lastIntent: null,
                conversationSummary: ''
            };
        }

        generateUUID() {
            return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c => {
                const r = Math.random() * 16 | 0;
                return (c === 'x' ? r : (r & 0x3 | 0x8)).toString(16);
            });
        }

        // Add user message to history
        addUserMessage(content, metadata = {}) {
            this.history.push({
                role: 'user',
                content,
                timestamp: Date.now(),
                metadata
            });
            this.trimHistory();
        }

        // Add assistant response to history
        addAssistantResponse(response) {
            this.history.push({
                role: 'assistant',
                content: this.summarizeResponse(response),
                responseType: response.responseType,
                timestamp: Date.now()
            });

            // Update context based on response
            if (response.contextUpdate) {
                Object.assign(this.context, response.contextUpdate);
            }

            // Track pending clarification
            if (response.responseType === 'clarification') {
                this.context.pendingClarification = response.content.clarification;
            } else {
                this.context.pendingClarification = null;
            }

            // Track active chart
            if (response.responseType === 'chart' && response.content.chart) {
                this.context.activeChart = {
                    type: response.content.chart.type,
                    title: response.content.chart.title,
                    metadata: response.content.chart.metadata
                };
            }

            this.trimHistory();
        }

        // Summarize response for history (avoid storing full HTML)
        summarizeResponse(response) {
            switch (response.responseType) {
                case 'chart':
                    return `[Graphique: ${response.content.chart?.title || 'Visualisation'}]`;
                case 'clarification':
                    return response.content.clarification?.question || '[Clarification demand√©e]';
                case 'text':
                    return response.content.text || '';
                case 'multi':
                    return response.content.parts?.map(p =>
                        p.type === 'text' ? p.content : `[${p.type}]`
                    ).join(' ') || '';
                default:
                    return '[R√©ponse]';
            }
        }

        // Keep history manageable
        trimHistory() {
            const MAX_HISTORY = 20;
            if (this.history.length > MAX_HISTORY) {
                this.history = this.history.slice(-MAX_HISTORY);
            }
        }

        // Build payload for workflow
        buildPayload(userMessage, gristContext, metadata = {}) {
            return {
                sessionId: this.sessionId,
                timestamp: Date.now(),

                message: {
                    type: metadata.type || 'user',
                    content: userMessage,
                    metadata: {
                        selectedSuggestion: metadata.suggestion || null,
                        selectedOption: metadata.clarificationOption || null,
                        selectedAction: metadata.action || null
                    }
                },

                conversationHistory: this.getFormattedHistory(),

                currentContext: {
                    activeChart: this.context.activeChart,
                    pendingClarification: this.context.pendingClarification,
                    appliedFilters: this.context.appliedFilters,
                    lastIntent: this.context.lastIntent
                },

                gristContext: gristContext
            };
        }

        // Format history for workflow
        getFormattedHistory() {
            return this.history.slice(-10).map(h => ({
                role: h.role,
                content: h.content,
                responseType: h.responseType || null,
                timestamp: h.timestamp
            }));
        }

        // Reset conversation
        reset() {
            this.history = [];
            this.context = {
                activeChart: null,
                pendingClarification: null,
                appliedFilters: [],
                lastIntent: null,
                conversationSummary: ''
            };
        }
    }

    // ===== MAIN APPLICATION =====
    class ChartAgentApp {
        constructor() {
            this.isGristReady = false;
            this.schema = null;
            this.allData = {};
            this.suggestions = [];
            this.currentChart = null;
            this.isLoading = false;

            this.conversation = new ConversationManager();

            this.config = {
                webhookUrl: localStorage.getItem('chart_agent_webhook') || ''
            };

            this.elements = {};
        }

        // ===== INITIALIZATION =====

        async initialize() {
            this.cacheElements();
            this.updateStatus('loading', 'Connexion...');

            // Add initial greeting
            this.addAssistantMessage({
                responseType: 'text',
                content: { text: 'Bonjour ! Je suis votre assistant d\'analyse de donn√©es. Posez-moi une question ou s√©lectionnez une suggestion.' }
            });

            try {
                await grist.ready({
                    requiredAccess: 'full',
                    columns: ['*'],
                    allowSelectBy: true
                });

                this.isGristReady = true;
                this.updateStatus('connected', 'Connect√©');

                await this.loadSchemaAndData();
                this.requestSuggestions();

            } catch (error) {
                console.error('Grist init error:', error);
                this.updateStatus('disconnected', 'Non connect√©');
                this.addAssistantMessage({
                    responseType: 'text',
                    content: { text: '‚ö†Ô∏è Widget non connect√© √† Grist. Configurez la connexion dans les param√®tres.' }
                });
            }
        }

        cacheElements() {
            this.elements = {
                statusIndicator: document.getElementById('status-indicator'),
                statusText: document.getElementById('status-text'),
                suggestionsPanel: document.getElementById('suggestions-panel'),
                suggestionsContent: document.getElementById('suggestions-content'),
                suggestionsGrid: document.getElementById('suggestions-grid'),
                chatMessages: document.getElementById('chat-messages'),
                chatInput: document.getElementById('chat-input'),
                chatSendBtn: document.getElementById('chat-send-btn'),
                chartPlaceholder: document.getElementById('chart-placeholder'),
                chartFrame: document.getElementById('chart-frame'),
                chartToolbar: document.getElementById('chart-toolbar'),
                chartTitle: document.getElementById('chart-title'),
                chartLoading: document.getElementById('chart-loading'),
                loadingText: document.getElementById('loading-text'),
                settingsModal: document.getElementById('settings-modal'),
                inputWebhookUrl: document.getElementById('input-webhook-url')
            };
        }

        updateStatus(status, text) {
            const indicator = this.elements.statusIndicator;
            indicator.className = 'status-indicator';
            if (status === 'disconnected') indicator.classList.add('disconnected');
            if (status === 'loading') indicator.classList.add('loading');
            this.elements.statusText.textContent = text;
        }

        // ===== SCHEMA & DATA LOADING =====

        async loadSchemaAndData() {
            try {
                const tableIds = await grist.docApi.listTables();
                const userTables = tableIds.filter(id => !id.startsWith('_grist_'));

                const [tablesData, columnsData] = await Promise.all([
                    grist.docApi.fetchTable('_grist_Tables'),
                    grist.docApi.fetchTable('_grist_Tables_column')
                ]);

                const schema = { tables: {}, relations: [] };

                for (const tableId of userTables) {
                    const tableIndex = tablesData.tableId.indexOf(tableId);
                    if (tableIndex === -1) continue;

                    const tableRef = tablesData.id[tableIndex];
                    const columns = [];

                    for (let i = 0; i < columnsData.id.length; i++) {
                        if (columnsData.parentId[i] !== tableRef) continue;

                        const colId = columnsData.colId[i];
                        const colType = columnsData.type[i];

                        if (['manualSort', 'id'].includes(colId)) continue;
                        if (colId.startsWith('gristHelper') && colId !== 'gristHelper_Display') continue;

                        let baseType = colType;
                        let refTable = null;

                        if (colType.startsWith('Ref:')) {
                            baseType = 'Ref';
                            refTable = colType.substring(4);
                            schema.relations.push({
                                from: tableId,
                                fromColumn: colId,
                                to: refTable,
                                type: 'Ref'
                            });
                        } else if (colType.startsWith('RefList:')) {
                            baseType = 'RefList';
                            refTable = colType.substring(8);
                            schema.relations.push({
                                from: tableId,
                                fromColumn: colId,
                                to: refTable,
                                type: 'RefList'
                            });
                        }

                        let choices = null;
                        if (colType === 'Choice' || colType === 'ChoiceList') {
                            try {
                                const opts = JSON.parse(columnsData.widgetOptions[i] || '{}');
                                choices = opts.choices || null;
                            } catch (e) {}
                        }

                        columns.push({
                            id: colId,
                            label: columnsData.label[i] || colId,
                            type: baseType,
                            fullType: colType,
                            refTable,
                            choices
                        });
                    }

                    schema.tables[tableId] = { columns };

                    const rawData = await grist.docApi.fetchTable(tableId);
                    this.allData[tableId] = this.convertToRecords(rawData);
                }

                this.schema = schema;
                console.log('üìã Schema:', schema);
                console.log('üìä Data:', Object.keys(this.allData).map(k => `${k}: ${this.allData[k].length}`));

            } catch (error) {
                console.error('Schema loading error:', error);
            }
        }

        convertToRecords(tableData) {
            if (!tableData || typeof tableData !== 'object') return [];
            const columns = Object.keys(tableData).filter(k => k !== 'manualSort');
            if (columns.length === 0) return [];

            const rowCount = tableData.id?.length || 0;
            const records = [];

            for (let i = 0; i < rowCount; i++) {
                const record = {};
                columns.forEach(col => {
                    record[col] = tableData[col][i];
                });
                records.push(record);
            }
            return records;
        }

        // Build Grist context for workflow
        buildGristContext() {
            return {
                schema: this.schema,
                data: this.allData,
                metadata: {
                    totalRecords: Object.fromEntries(
                        Object.entries(this.allData).map(([k, v]) => [k, v.length])
                    ),
                    lastUpdate: Date.now()
                }
            };
        }

        // ===== SUGGESTIONS =====

        async requestSuggestions() {
            if (!this.config.webhookUrl) {
                this.generateLocalSuggestions();
                return;
            }

            this.elements.suggestionsPanel.classList.add('visible');
            this.elements.suggestionsGrid.innerHTML = `
                <div class="suggestions-loading">
                    <div class="mini-spinner"></div>
                    <span>Analyse du document...</span>
                </div>
            `;

            try {
                const response = await fetch(this.config.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        action: 'analyze',
                        schema: this.schema,
                        dataSummary: this.buildDataSummary()
                    })
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();

                if (result.suggestions && result.suggestions.length > 0) {
                    this.suggestions = result.suggestions;
                    this.renderSuggestions();
                } else {
                    this.generateLocalSuggestions();
                }

            } catch (error) {
                console.error('Suggestions error:', error);
                this.generateLocalSuggestions();
            }
        }

        buildDataSummary() {
            const summary = {};
            for (const [tableId, records] of Object.entries(this.allData)) {
                const columns = this.schema.tables[tableId]?.columns || [];
                summary[tableId] = {
                    count: records.length,
                    columns: columns.map(c => ({ id: c.id, type: c.type, label: c.label, choices: c.choices })),
                    sample: records.slice(0, 3)
                };
            }
            return summary;
        }

        generateLocalSuggestions() {
            this.suggestions = [];

            for (const [tableId, tableInfo] of Object.entries(this.schema?.tables || {})) {
                const columns = tableInfo.columns;
                const records = this.allData[tableId] || [];
                if (records.length === 0) continue;

                const choiceCols = columns.filter(c => c.type === 'Choice');
                const numericCols = columns.filter(c => ['Numeric', 'Int'].includes(c.type));
                const refCols = columns.filter(c => c.type === 'Ref');

                for (const col of choiceCols.slice(0, 2)) {
                    this.suggestions.push({
                        icon: 'ü•ß',
                        title: `R√©partition par ${col.label}`,
                        subtitle: tableId,
                        prompt: `Montre-moi la r√©partition par ${col.label} dans ${tableId}`
                    });
                }

                if (choiceCols.length > 0 && numericCols.length > 0) {
                    this.suggestions.push({
                        icon: 'üìä',
                        title: `${numericCols[0].label} par ${choiceCols[0].label}`,
                        subtitle: tableId,
                        prompt: `Montre-moi ${numericCols[0].label} par ${choiceCols[0].label} dans ${tableId}`
                    });
                }

                if (choiceCols.length >= 2) {
                    this.suggestions.push({
                        icon: 'üîÑ',
                        title: `Flux ${choiceCols[0].label} ‚Üí ${choiceCols[1].label}`,
                        subtitle: tableId,
                        prompt: `Montre-moi le flux de ${choiceCols[0].label} vers ${choiceCols[1].label} dans ${tableId}`
                    });
                }
            }

            this.suggestions = this.suggestions.slice(0, 6);

            if (this.suggestions.length > 0) {
                this.renderSuggestions();
            }
        }

        renderSuggestions() {
            if (this.suggestions.length === 0) {
                this.elements.suggestionsPanel.classList.remove('visible');
                return;
            }

            this.elements.suggestionsPanel.classList.add('visible');

            this.elements.suggestionsGrid.innerHTML = this.suggestions.map((s, idx) => `
                <div class="suggestion-card" onclick="app.selectSuggestion(${idx})">
                    <div class="suggestion-icon">${s.icon}</div>
                    <div class="suggestion-title">${s.title}</div>
                    <div class="suggestion-subtitle">${s.subtitle}</div>
                </div>
            `).join('');
        }

        async selectSuggestion(index) {
            const suggestion = this.suggestions[index];
            if (!suggestion) return;

            document.querySelectorAll('.suggestion-card').forEach((el, i) => {
                el.classList.toggle('selected', i === index);
            });

            const prompt = suggestion.prompt || suggestion.title;
            await this.processUserInput(prompt, { type: 'suggestion', suggestion });
        }

        // ===== CHAT & MESSAGE HANDLING =====

        async sendMessage() {
            const input = this.elements.chatInput;
            const prompt = input.value.trim();
            if (!prompt || this.isLoading) return;

            input.value = '';
            await this.processUserInput(prompt);
        }

        async processUserInput(content, metadata = {}) {
            // Add user message to UI and history
            this.addUserMessageToUI(content);
            this.conversation.addUserMessage(content, metadata);

            if (!this.config.webhookUrl) {
                this.addAssistantMessage({
                    responseType: 'text',
                    content: { text: '‚ö†Ô∏è Veuillez configurer l\'URL du webhook dans les param√®tres.' }
                });
                this.openSettings();
                return;
            }

            // Show typing indicator
            this.showTypingIndicator();
            this.setLoading(true, 'Analyse de votre demande...');

            try {
                // Build and send payload
                const payload = this.conversation.buildPayload(
                    content,
                    this.buildGristContext(),
                    metadata
                );

                const response = await fetch(this.config.webhookUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) throw new Error(`HTTP ${response.status}`);

                const result = await response.json();

                // Remove typing indicator
                this.hideTypingIndicator();

                // Process response
                await this.handleWorkflowResponse(result);

            } catch (error) {
                console.error('Request error:', error);
                this.hideTypingIndicator();
                this.addAssistantMessage({
                    responseType: 'text',
                    content: { text: `‚ùå Erreur: ${error.message}` }
                });
            } finally {
                this.setLoading(false);
            }
        }

        // Handle response from workflow
        async handleWorkflowResponse(response) {
            // Add to conversation history
            this.conversation.addAssistantResponse(response);

            // Handle different response types
            switch (response.responseType) {
                case 'text':
                    this.addAssistantMessage(response);
                    break;

                case 'chart':
                    this.handleChartResponse(response);
                    break;

                case 'clarification':
                    this.handleClarificationResponse(response);
                    break;

                case 'multi':
                    this.handleMultiResponse(response);
                    break;

                case 'error':
                    this.addAssistantMessage({
                        responseType: 'text',
                        content: { text: `‚ùå ${response.content.error || 'Erreur inconnue'}` }
                    });
                    break;

                default:
                    // Fallback for legacy responses
                    if (response.success && response.html) {
                        this.handleLegacyChartResponse(response);
                    } else {
                        this.addAssistantMessage({
                            responseType: 'text',
                            content: { text: response.message || 'R√©ponse re√ßue.' }
                        });
                    }
            }

            // Handle suggested actions
            if (response.suggestedActions && response.suggestedActions.length > 0) {
                this.showSuggestedActions(response.suggestedActions);
            }
        }

        handleChartResponse(response) {
            const chart = response.content.chart;

            // Display chart
            this.displayChart(chart.html, chart.title);

            // Add message with chart info
            const msg = document.createElement('div');
            msg.className = 'message assistant';
            msg.innerHTML = `
                <div class="message-bubble">
                    ‚úÖ ${chart.title || 'Visualisation'} g√©n√©r√©
                    ${chart.metadata?.recordCount ? `<br><small>${chart.metadata.recordCount} enregistrements analys√©s</small>` : ''}
                </div>
            `;
            this.elements.chatMessages.appendChild(msg);
            this.scrollChat();
        }

        handleClarificationResponse(response) {
            const clarification = response.content.clarification;

            const msg = document.createElement('div');
            msg.className = 'message assistant';

            let optionsHtml = '';
            if (clarification.options && clarification.options.length > 0) {
                optionsHtml = `
                    <div class="clarification-options">
                        ${clarification.options.map((opt, idx) => `
                            <div class="clarification-option" onclick="app.selectClarificationOption(${idx}, '${opt.id}')">
                                <div class="clarification-option-label">${opt.label}</div>
                                ${opt.description ? `<div class="clarification-option-desc">${opt.description}</div>` : ''}
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            msg.innerHTML = `
                <div class="message-bubble">${clarification.question}</div>
                ${optionsHtml}
            `;

            this.elements.chatMessages.appendChild(msg);
            this.scrollChat();

            // Store options for selection
            this.pendingClarificationOptions = clarification.options;
        }

        async selectClarificationOption(index, optionId) {
            const option = this.pendingClarificationOptions?.[index];
            if (!option) return;

            await this.processUserInput(option.label, {
                type: 'clarification_response',
                clarificationOption: option
            });
        }

        handleMultiResponse(response) {
            const parts = response.content.parts || [];

            for (const part of parts) {
                switch (part.type) {
                    case 'text':
                        this.addAssistantMessage({
                            responseType: 'text',
                            content: { text: part.content }
                        });
                        break;

                    case 'chart':
                        this.handleChartResponse({
                            responseType: 'chart',
                            content: { chart: part.content }
                        });
                        break;
                }
            }
        }

        handleLegacyChartResponse(response) {
            // Handle old format responses for backward compatibility
            this.displayChart(response.html, response.title);

            this.addAssistantMessage({
                responseType: 'text',
                content: { text: `‚úÖ ${response.title || 'Visualisation'} g√©n√©r√© (${response.recordCount || '?'} enregistrements)` }
            });
        }

        showSuggestedActions(actions) {
            const container = document.createElement('div');
            container.className = 'suggested-actions';
            container.innerHTML = actions.map(action => `
                <button class="action-btn" onclick="app.executeAction('${action.id}', ${JSON.stringify(action.params || {}).replace(/"/g, '&quot;')})">
                    ${action.label}
                </button>
            `).join('');

            this.elements.chatMessages.appendChild(container);
            this.scrollChat();
        }

        async executeAction(actionId, params) {
            await this.processUserInput(`[Action: ${actionId}]`, {
                type: 'action',
                action: { id: actionId, params }
            });
        }

        // ===== UI HELPERS =====

        addUserMessageToUI(content) {
            const msg = document.createElement('div');
            msg.className = 'message user';
            msg.innerHTML = `<div class="message-bubble">${this.escapeHtml(content)}</div>`;
            this.elements.chatMessages.appendChild(msg);
            this.scrollChat();
        }

        addAssistantMessage(response) {
            const msg = document.createElement('div');
            msg.className = 'message assistant';

            let text = '';
            if (response.responseType === 'text' && response.content?.text) {
                text = response.content.text;
            } else if (typeof response === 'string') {
                text = response;
            }

            msg.innerHTML = `<div class="message-bubble">${this.escapeHtml(text)}</div>`;
            this.elements.chatMessages.appendChild(msg);
            this.scrollChat();
        }

        showTypingIndicator() {
            const indicator = document.createElement('div');
            indicator.className = 'typing-indicator';
            indicator.id = 'typing-indicator';
            indicator.innerHTML = '<span></span><span></span><span></span>';
            this.elements.chatMessages.appendChild(indicator);
            this.scrollChat();
        }

        hideTypingIndicator() {
            const indicator = document.getElementById('typing-indicator');
            if (indicator) indicator.remove();
        }

        scrollChat() {
            this.elements.chatMessages.scrollTop = this.elements.chatMessages.scrollHeight;
        }

        escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        displayChart(html, title) {
            this.elements.chartPlaceholder.style.display = 'none';
            this.elements.chartFrame.style.display = 'block';
            this.elements.chartFrame.srcdoc = html;
            this.elements.chartToolbar.classList.add('visible');
            this.elements.chartTitle.textContent = title || 'Visualisation';

            this.currentChart = { html, title };
        }

        setLoading(loading, text = 'G√©n√©ration en cours...') {
            this.isLoading = loading;
            this.elements.chartLoading.classList.toggle('visible', loading);
            this.elements.loadingText.textContent = text;
            this.elements.chatSendBtn.disabled = loading;
        }

        // ===== CHART ACTIONS =====

        expandChart() {
            if (this.currentChart?.html) {
                const win = window.open('', '_blank');
                win.document.write(this.currentChart.html);
                win.document.close();
            }
        }

        downloadChart() {
            if (this.currentChart?.html) {
                const blob = new Blob([this.currentChart.html], { type: 'text/html' });
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = `${this.currentChart.title || 'chart'}_${Date.now()}.html`;
                a.click();
            }
        }

        toggleSuggestions() {
            this.elements.suggestionsPanel.classList.toggle('collapsed');
        }

        // ===== SETTINGS =====

        openSettings() {
            this.elements.inputWebhookUrl.value = this.config.webhookUrl;
            this.elements.settingsModal.classList.add('visible');
        }

        closeSettings() {
            this.elements.settingsModal.classList.remove('visible');
        }

        saveSettings() {
            this.config.webhookUrl = this.elements.inputWebhookUrl.value.trim();
            localStorage.setItem('chart_agent_webhook', this.config.webhookUrl);
            this.closeSettings();

            this.addAssistantMessage({
                responseType: 'text',
                content: { text: '‚úÖ Configuration enregistr√©e. Je suis pr√™t √† vous aider !' }
            });

            if (this.config.webhookUrl && this.schema) {
                this.requestSuggestions();
            }
        }
    }

    // ===== INIT =====
    const app = new ChartAgentApp();
    document.addEventListener('DOMContentLoaded', () => app.initialize());
    </script>
</body>
</html>
